<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ±</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #0284c7; 
            --danger: #ef4444;
            --success: #10b981;
            --bg: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); background-attachment: fixed; 
            margin: 0; padding: 10px; color: #0c4a6e; min-height: 100vh;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header-area {
            text-align: center; padding: 15px; background: white;
            border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± (2 ÙÙŠ Ø§Ù„ØµÙ) */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .main-btn { 
            background: white; border: 1px solid #bae6fd; padding: 20px 5px; 
            border-radius: 18px; cursor: pointer; font-weight: bold; 
            color: #0369a1; box-shadow: 0 4px 0 #38bdf8;
            transition: 0.1s; display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .main-btn:active { transform: translateY(3px); box-shadow: 0 0px 0 #38bdf8; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 10001; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .admin-section { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 10px; border-radius: 8px; width: 100%; border: none; font-weight: bold; cursor: pointer; color: white; margin-bottom: 5px; }
        .btn-add { background: var(--primary); }
        .btn-save { background: var(--success); }
        .btn-edit { background: #f59e0b; padding: 4px 8px; width: auto; font-size: 11px; }
        .btn-del { background: var(--danger); padding: 4px 8px; width: auto; font-size: 11px; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 20px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }
        #modalImg { width: 100%; border-radius: 15px; max-height: 180px; object-fit: cover; margin-bottom: 10px; }
        
        .admin-trigger { position: fixed; bottom: 10px; left: 10px; width: 35px; height: 35px; opacity: 0.1; cursor: pointer; z-index: 9999; }
        .back-nav { margin-top: 20px; }
        .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>

    <div class="header-area">
        <small id="breadCrumb" style="color: var(--primary);">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</small>
        <h2 id="mainHeading" style="margin: 5px 0;">Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙØ±Ù†Ø³ÙŠ</h2>
    </div>

    <div id="appContainer" class="grid-container"></div>

    <div id="navArea" class="back-nav" style="display:none;">
        <button class="btn" style="background: #64748b;" onclick="goBack()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù</button>
    </div>

    <div class="admin-trigger" onclick="checkAdmin()">âš™ï¸</div>

    <div id="adminPanel">
        <h2 style="text-align:center;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
        
        <div class="admin-section">
            <h4>ğŸ“¦ 1. Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…</h4>
            <input type="hidden" id="editCatId">
            <select id="catParentSelect"><option value="root">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option></select>
            <input type="text" id="catNameInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¨Ø§Ø·Ù†Ø©ØŒ Ø£Ø·Ø¨Ø§Ø¡..)">
            <button class="btn btn-add" id="btnSaveCat" onclick="saveCategory()">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="admin-section">
            <h4>ğŸ‘¤ 2. Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙƒØªÙˆØ±</h4>
            <input type="hidden" id="editItemId">
            <select id="itemParentSelect"></select>
            <input type="text" id="itemName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="file" id="imgFile" accept="image/*">
            <input type="text" id="itemTime" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯">
            <input type="text" id="itemMap" placeholder="Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨">
            <input type="text" id="itemWa" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
            <button class="btn btn-save" id="btnSaveItem" onclick="saveItem()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div class="admin-section">
            <h4>ğŸ“‹ 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
            <div id="adminList"></div>
        </div>

        <button class="btn" style="background: #000;" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <img id="modalImg">
            <div id="modalInfo" style="text-align: right; background: #f0f9ff; padding: 10px; border-radius: 12px; margin-bottom: 10px; font-size: 14px;"></div>
            <a id="modalMap" class="btn" style="background: var(--primary); text-decoration: none; display: block;" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
            <a id="modalWa" class="btn" style="background: var(--success); text-decoration: none; display: block;" target="_blank">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
            <button class="btn" style="background: none; color: #64748b;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpRvNYUZhsaAUlwk4_n94KNgK50rhfD-0",
            databaseURL: "https://al-qasr-hospital-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let cats = [];
        let items = [];
        let path = ['root'];

        // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        rdb.ref('global_data/cats').on('value', s => {
            const data = s.val() || {};
            cats = Object.entries(data).map(([id, v]) => ({id, ...v}));
            renderUI();
            updateSelectors();
        });

        rdb.ref('global_data/items').on('value', s => {
            const data = s.val() || {};
            items = Object.entries(data).map(([id, v]) => ({id, ...v}));
            renderUI();
        });

        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function renderUI() {
            const container = document.getElementById('appContainer');
            const parent = path[path.length - 1];
            container.innerHTML = '';
            
            document.getElementById('breadCrumb').innerText = path.join(' > ').replace('root', 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
            document.getElementById('navArea').style.display = path.length > 1 ? 'block' : 'none';

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            cats.filter(c => c.parent === parent).forEach(c => {
                const b = document.createElement('button');
                b.className = 'main-btn';
                b.innerHTML = `<span style="font-size:24px">ğŸ“‚</span>${c.name}`;
                b.onclick = () => { path.push(c.name); renderUI(); };
                container.appendChild(b);
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
            items.filter(i => i.parent === parent).forEach(i => {
                const b = document.createElement('button');
                b.className = 'main-btn';
                b.style.background = "#f0f9ff";
                b.innerHTML = `<span style="font-size:24px">ğŸ‘¤</span>${i.name}`;
                b.onclick = () => showDetails(i);
                container.appendChild(b);
            });
        }

        function goBack() { path.pop(); renderUI(); }

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---

        // 1. Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        function saveCategory() {
            const name = document.getElementById('catNameInp').value;
            const parent = document.getElementById('catParentSelect').value;
            const editId = document.getElementById('editCatId').value;

            if(!name) return;
            if(editId) {
                rdb.ref('global_data/cats/' + editId).update({ name, parent });
                document.getElementById('editCatId').value = '';
                document.getElementById('btnSaveCat').innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯";
            } else {
                rdb.ref('global_data/cats').push({ name, parent });
            }
            document.getElementById('catNameInp').value = '';
        }

        // 2. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡)
        async function saveItem() {
            const name = document.getElementById('itemName').value;
            const parent = document.getElementById('itemParentSelect').value;
            const editId = document.getElementById('editItemId').value;
            const file = document.getElementById('imgFile').files[0];
            
            let imgData = "";
            if(file) imgData = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });

            const obj = {
                name, parent, 
                time: document.getElementById('itemTime').value,
                map: document.getElementById('itemMap').value,
                wa: document.getElementById('itemWa').value
            };
            if(imgData) obj.img = imgData;

            if(editId) {
                rdb.ref('global_data/items/' + editId).update(obj);
                document.getElementById('editItemId').value = '';
                document.getElementById('btnSaveItem').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            } else {
                rdb.ref('global_data/items').push(obj);
            }
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
            resetItemForm();
        }

        // 3. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù
        function updateSelectors() {
            const s1 = document.getElementById('catParentSelect');
            const s2 = document.getElementById('itemParentSelect');
            let h = '<option value="root">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>';
            cats.forEach(c => h += `<option value="${c.name}">${c.name}</option>`);
            s1.innerHTML = h;
            s2.innerHTML = h;

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            const list = document.getElementById('adminList');
            list.innerHTML = '<strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong>';
            cats.forEach(c => {
                list.innerHTML += `<div class="manage-item">ğŸ“‚ ${c.name} 
                    <div>
                        <button class="btn btn-edit" onclick="editCat('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-del" onclick="deleteData('cats','${c.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>`;
            });
            list.innerHTML += '<br><strong>Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡/Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>';
            items.forEach(i => {
                list.innerHTML += `<div class="manage-item">ğŸ‘¤ ${i.name} 
                    <div>
                        <button class="btn btn-edit" onclick="editItem('${i.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-del" onclick="deleteData('items','${i.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>`;
            });
        }

        function editCat(id) {
            const c = cats.find(x => x.id === id);
            document.getElementById('editCatId').value = id;
            document.getElementById('catNameInp').value = c.name;
            document.getElementById('catParentSelect').value = c.parent;
            document.getElementById('btnSaveCat').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ù…";
            document.getElementById('adminPanel').scrollTo(0,0);
        }

        function editItem(id) {
            const i = items.find(x => x.id === id);
            document.getElementById('editItemId').value = id;
            document.getElementById('itemName').value = i.name;
            document.getElementById('itemParentSelect').value = i.parent;
            document.getElementById('itemTime').value = i.time;
            document.getElementById('itemMap').value = i.map;
            document.getElementById('itemWa').value = i.wa;
            document.getElementById('btnSaveItem').innerText = "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ±";
            document.getElementById('adminPanel').scrollTo(0,0);
        }

        function deleteData(type, id) { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) rdb.ref(`global_data/${type}/${id}`).remove(); }

        function showDetails(i) {
            document.getElementById('modalTitle').innerText = i.name;
            const img = document.getElementById('modalImg');
            if(i.img) { img.src = i.img; img.style.display = 'block'; } else { img.style.display = 'none'; }
            document.getElementById('modalInfo').innerHTML = `<p><b>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:</b> ${i.time}</p>`;
            const m = document.getElementById('modalMap');
            if(i.map) { m.href = i.map; m.style.display = 'block'; } else { m.style.display = 'none'; }
            document.getElementById('modalWa').href = `https://wa.me/20${i.wa}`;
            document.getElementById('detailModal').style.display = 'flex';
        }

        function resetItemForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('itemTime').value = '';
            document.getElementById('itemMap').value = '';
            document.getElementById('itemWa').value = '';
            document.getElementById('imgFile').value = '';
        }

        function checkAdmin() { if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1987") document.getElementById('adminPanel').style.display = 'block'; }
        function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }
        function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
    </script>
</body>
</html>
