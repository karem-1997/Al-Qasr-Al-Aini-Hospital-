<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù‚ØµØ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --blue: #0284c7; --light-bg: #f8fafc; --white: #ffffff; --danger: #ef4444; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #e0f2fe; margin: 0; padding: 15px; direction: rtl; }
        
        .header { text-align: center; background: var(--white); padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #breadCrumb { font-size: 13px; color: var(--blue); font-weight: bold; margin-bottom: 5px; display: block; }

        /* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± 2 ÙÙŠ Ø§Ù„ØµÙ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { 
            background: var(--white); border: none; padding: 25px 10px; 
            border-radius: 20px; text-align: center; cursor: pointer;
            box-shadow: 0 6px 0 #bae6fd, 0 8px 15px rgba(0,0,0,0.05); 
            font-weight: 900; color: #0369a1; transition: 0.1s;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .card:active { transform: translateY(4px); box-shadow: 0 2px 0 #bae6fd; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 10000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .admin-box { background: var(--white); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #cbd5e1; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; font-size: 16px; }
        
        .btn-blue { background: var(--blue); }
        .btn-green { background: #10b981; }
        .btn-red { background: var(--danger); }
        .btn-edit { background: #f59e0b; padding: 5px 10px; font-size: 12px; width: auto; border-radius: 5px; color: white; border: none; }
        .btn-del { background: var(--danger); padding: 5px 10px; font-size: 12px; width: auto; border-radius: 5px; color: white; border: none; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: var(--white); padding: 25px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; position: relative; }
        #modalImg { width: 100%; border-radius: 20px; max-height: 200px; object-fit: cover; margin-bottom: 15px; border: 2px solid #f0f9ff; }

        .back-nav { margin-top: 30px; }
        .admin-trigger { position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; opacity: 0.1; cursor: pointer; z-index: 10001; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div class="header">
        <span id="breadCrumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        <h2 style="margin: 0; color: #0369a1;">Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙØ±Ù†Ø³ÙŠ</h2>
    </div>

    <div id="mainGrid" class="grid"></div>

    <div id="backNav" class="back-nav" style="display:none;">
        <button class="action-btn" style="background:#64748b" onclick="goBack()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø§Ø¨Ù‚</button>
    </div>

    <div class="admin-trigger" onclick="openAdmin()">âš™ï¸</div>

    <div id="adminPanel">
        <h2 style="text-align:center; color: var(--blue);">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
        
        <div class="admin-box">
            <h4>ğŸ“¦ 1. Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø±Ø¦ÙŠØ³ÙŠ / ÙØ±Ø¹ÙŠ)</h4>
            <input type="hidden" id="editCatId">
            <select id="catParentSelect"><option value="root">-- Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯ --</option></select>
            <input type="text" id="catName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <button class="action-btn btn-blue" id="catBtn" onclick="handleCategory()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… âœ…</button>
        </div>

        <div class="admin-box">
            <h4>ğŸ‘¤ 2. Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙƒØªÙˆØ±</h4>
            <input type="hidden" id="editDrId">
            <select id="drParentSelect"></select>
            <input type="text" id="drName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±">
            <input type="file" id="drFile" accept="image/*">
            <input type="text" id="drTime" placeholder="Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯">
            <input type="text" id="drMap" placeholder="Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨">
            <input type="text" id="drWa" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
            <button class="action-btn btn-green" id="drBtn" onclick="handleDoctor()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± âœ…</button>
        </div>

        <div class="admin-box">
            <h4>ğŸ“‹ 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù)</h4>
            <div id="adminList"></div>
        </div>

        <button class="action-btn btn-red" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>

    <div id="modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="mTitle" style="color:#0369a1; margin-top:0;"></h2>
            <img id="modalImg">
            <div id="mInfo" style="text-align:right; background:#f0f9ff; padding:15px; border-radius:15px; margin-bottom:15px; line-height:1.6;"></div>
            <a id="mMap" class="action-btn btn-blue" style="text-decoration:none; display:block" target="_blank">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Map)</a>
            <a id="mWa" class="action-btn btn-green" style="text-decoration:none; display:block" target="_blank">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</a>
            <button class="action-btn" style="background:none; color:#64748b;" onclick="document.getElementById('modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
        </div>
    </div>

    <script>
        // Ø±Ø¨Ø· Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpRvNYUZhsaAUlwk4_n94KNgK50rhfD-0",
            databaseURL: "https://al-qasr-hospital-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let categories = [];
        let doctors = [];
        let path = ['root'];

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
        db.ref('hospital_sys').on('value', (snap) => {
            const data = snap.val() || {};
            categories = data.cats ? Object.entries(data.cats).map(([id, v]) => ({id, ...v})) : [];
            doctors = data.drs ? Object.entries(data.drs).map(([id, v]) => ({id, ...v})) : [];
            renderUI();
            updateAdminDashboard();
        });

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø´Ø¨ÙƒØ© 2x2)
        function renderUI() {
            const grid = document.getElementById('mainGrid');
            const parent = path[path.length - 1];
            grid.innerHTML = '';
            
            document.getElementById('breadCrumb').innerText = path.join(' > ').replace('root', 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
            document.getElementById('backNav').style.display = path.length > 1 ? 'block' : 'none';

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            categories.filter(c => c.parent === parent).forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'card';
                btn.innerHTML = `<span style="font-size:35px">ğŸ“‚</span> ${c.name}`;
                btn.onclick = () => { path.push(c.name); renderUI(); };
                grid.appendChild(btn);
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©
            doctors.filter(d => d.parent === parent).forEach(d => {
                const btn = document.createElement('div');
                btn.className = 'card';
                btn.style.background = 'linear-gradient(to bottom, #ffffff, #f0f9ff)';
                btn.innerHTML = `<span style="font-size:35px">ğŸ‘¤</span> ${d.name}`;
                btn.onclick = () => showDetails(d);
                grid.appendChild(btn);
            });
        }

        function goBack() { path.pop(); renderUI(); }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---
        function handleCategory() {
            const name = document.getElementById('catName').value;
            const parent = document.getElementById('catParentSelect').value;
            const editId = document.getElementById('editCatId').value;
            if(!name) return;

            if(editId) {
                db.ref('hospital_sys/cats/' + editId).update({ name, parent });
                document.getElementById('editCatId').value = '';
                document.getElementById('catBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… âœ…";
            } else {
                db.ref('hospital_sys/cats').push({ name, parent });
            }
            document.getElementById('catName').value = '';
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© ---
        async function handleDoctor() {
            const name = document.getElementById('drName').value;
            const parent = document.getElementById('drParentSelect').value;
            const editId = document.getElementById('editDrId').value;
            const file = document.getElementById('drFile').files[0];
            
            let img = "";
            if(file) img = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });

            const data = {
                name, parent, 
                time: document.getElementById('drTime').value,
                map: document.getElementById('drMap').value,
                wa: document.getElementById('drWa').value
            };
            if(img) data.img = img;

            if(editId) {
                db.ref('hospital_sys/drs/' + editId).update(data);
                document.getElementById('editDrId').value = '';
                document.getElementById('drBtn').innerText = "Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± âœ…";
            } else {
                db.ref('hospital_sys/drs').push(data);
            }
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
            resetDrForm();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        function updateAdminDashboard() {
            const cSel = document.getElementById('catParentSelect');
            const dSel = document.getElementById('drParentSelect');
            const list = document.getElementById('adminList');
            
            let opts = '<option value="root">-- Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯ --</option>';
            categories.forEach(c => opts += `<option value="${c.name}">${c.name}</option>`);
            cSel.innerHTML = opts;
            dSel.innerHTML = opts.replace('-- Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯ --', '-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© --');

            list.innerHTML = '<strong>ğŸ“ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong>';
            categories.forEach(c => {
                list.innerHTML += `<div class="list-row">${c.name} <div>
                    <button class="btn-edit" onclick="editCategory('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-del" onclick="deleteEntry('cats','${c.id}')">Ø­Ø°Ù</button>
                </div></div>`;
            });

            list.innerHTML += '<br><strong>ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©:</strong>';
            doctors.forEach(d => {
                list.innerHTML += `<div class="list-row">${d.name} (${d.parent}) <div>
                    <button class="btn-edit" onclick="editDoctor('${d.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn-del" onclick="deleteEntry('drs','${d.id}')">Ø­Ø°Ù</button>
                </div></div>`;
            });
        }

        function editCategory(id) {
            const c = categories.find(x => x.id === id);
            document.getElementById('editCatId').value = id;
            document.getElementById('catName').value = c.name;
            document.getElementById('catParentSelect').value = c.parent;
            document.getElementById('catBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¢Ù† ğŸ”„";
            document.getElementById('adminPanel').scrollTo(0,0);
        }

        function editDoctor(id) {
            const d = doctors.find(x => x.id === id);
            document.getElementById('editDrId').value = id;
            document.getElementById('drName').value = d.name;
            document.getElementById('drParentSelect').value = d.parent;
            document.getElementById('drTime').value = d.time;
            document.getElementById('drMap').value = d.map;
            document.getElementById('drWa').value = d.wa;
            document.getElementById('drBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ù„Ø¢Ù† ğŸ”„";
            document.getElementById('adminPanel').scrollTo(0,0);
        }

        function deleteEntry(type, id) { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) db.ref(`hospital_sys/${type}/${id}`).remove(); }

        function showDetails(d) {
            document.getElementById('mTitle').innerText = d.name;
            const img = document.getElementById('modalImg');
            if(d.img) { img.src = d.img; img.style.display = 'block'; } else { img.style.display = 'none'; }
            document.getElementById('mInfo').innerHTML = `<p><b>ğŸ•’ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:</b><br>${d.time}</p>`;
            const map = document.getElementById('mMap');
            if(d.map) { map.href = d.map; map.style.display='block'; } else { map.style.display='none'; }
            document.getElementById('mWa').href = `https://wa.me/20${d.wa}`;
            document.getElementById('modal').style.display = 'flex';
        }

        function resetDrForm() {
            document.getElementById('drName').value=''; document.getElementById('drTime').value='';
            document.getElementById('drMap').value=''; document.getElementById('drWa').value='';
            document.getElementById('drFile').value='';
        }

        function openAdmin() { if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1987") document.getElementById('adminPanel').style.display='block'; }
        function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }
    </script>
</body>
</html>
