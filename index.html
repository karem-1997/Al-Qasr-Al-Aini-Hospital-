<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„Ø¹ÙŠÙ†ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #0284c7; 
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 100%);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg-gradient); background-attachment: fixed; 
            margin: 0; padding: 15px; color: #0c4a6e;
            min-height: 100vh; display: flex; flex-direction: column;
        }

        .header-area {
            text-align: center; padding: 20px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); border-radius: 20px;
            margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.4);
        }

        #mainCategories { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .cat-btn { 
            background: white; border: none; padding: 25px; border-radius: 20px;
            font-size: 20px; font-weight: 900; color: #0369a1; cursor: pointer;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #subPage { display: none; flex-grow: 1; }
        #buttonsContainer { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .main-btn { 
            background: linear-gradient(to bottom, #ffffff, #e0f2fe);
            border: 1px solid #bae6fd; padding: 18px 10px; 
            border-radius: 18px; cursor: pointer; font-weight: 800; 
            color: #0369a1; box-shadow: 0 5px 0 #38bdf8, 0 8px 12px rgba(0,0,0,0.1);
            transition: 0.1s; font-size: 15px;
        }
        .main-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #38bdf8; }

        .back-btn { background: #64748b; color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 20px; }

        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10001; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .admin-section { background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 10px; font-family: inherit; }
        .btn-action { padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; border: none; color: white; width: 100%; margin-top: 5px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 20px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; }
        #modalImg { width: 100%; border-radius: 15px; max-height: 180px; object-fit: cover; margin-bottom: 15px; }
        .info-card { text-align: right; background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; }
        
        .map-btn { display: block; background: #0ea5e9; color: white; text-decoration: none; padding: 12px; border-radius: 15px; margin: 10px 0; font-weight: bold; }
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; width: 40px; height: 40px; opacity: 0.1; cursor: pointer; z-index: 9999; }
    </style>
</head>
<body>

    <div class="header-area">
        <h1 id="mainHeading">ØªØ­Ù…ÙŠÙ„...</h1>
        <div id="siteBrief"></div>
    </div>

    <div id="mainCategories"></div>

    <div id="subPage">
        <h2 id="currentCatTitle" style="text-align: center; color: #0369a1;"></h2>
        <div id="buttonsContainer"></div>
        <button class="back-btn" onclick="goBack()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div class="admin-trigger" onclick="checkAdmin()">âš™ï¸</div>

    <div id="adminPanel">
        <h2 style="text-align:center;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h2>
        
        <div class="admin-section">
            <h4>ğŸ“¦ 1. Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø¹Ø¸Ø§Ù…)</h4>
            <div style="display:flex; gap:5px;">
                <input type="text" id="newCatInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="margin:0;">
                <button class="btn-action" style="background: #0369a1; width: 80px; margin:0;" onclick="addCategory()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="catsList" style="margin-top:10px; font-size:12px; color:#64748b;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
        </div>

        <div class="admin-section">
            <h4 id="formTitle">â• 2. Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª (Ø¯ÙƒØªÙˆØ±/Ø¹ÙŠØ§Ø¯Ø©)</h4>
            <input type="hidden" id="editKey">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
            <select id="parentCatSelect"></select>
            
            <input type="text" id="btnName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="file" id="imgFile" accept="image/*">
            
            <div style="display:flex; gap:5px;">
                <input type="text" id="tStart" placeholder="Ù…Ù†" style="flex:1">
                <select id="pStart" style="flex:1"><option>ØµØ¨Ø§Ø­Ø§Ù‹</option><option>Ù…Ø³Ø§Ø¡Ù‹</option></select>
                <input type="text" id="tEnd" placeholder="Ø¥Ù„Ù‰" style="flex:1">
                <select id="pEnd" style="flex:1"><option>Ù…Ø³Ø§Ø¡Ù‹</option><option>ØµØ¨Ø§Ø­Ø§Ù‹</option></select>
            </div>

            <div id="customFields"></div>
            <button onclick="addCustomField('', '')" style="background:#6366f1; color:white; border:none; padding:8px; border-radius:8px; width:100%; margin-bottom:10px;">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù†Ø© ÙˆØµÙ</button>

            <input type="text" id="mapLink" placeholder="Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨ (Location)">
            <input type="text" id="whatsapp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
            
            <button id="mainSaveBtn" class="btn-action" style="background:var(--accent);" onclick="saveToFirebase()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…</button>
            <button id="cancelEditBtn" class="btn-action" style="background:#94a3b8; display:none;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>

        <button class="btn-action" style="background:#ef4444;" onclick="closeAdmin()">âŒ Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        <div id="manageDataList" style="margin-top:20px;"></div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="color:#0369a1; margin:0 0 10px 0;"></h2>
            <img id="modalImg">
            <div id="modalDataBox" class="info-card"></div>
            <a id="modalMap" class="map-btn" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
            <a id="modalWa" href="#" target="_blank" style="display:block; background:#25d366; color:white; text-decoration:none; padding:15px; border-radius:15px; margin-top:10px; font-weight:bold;">ğŸ’¬ ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
            <button onclick="closeModal()" style="border:none; background:none; color:#64748b; margin-top:15px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpRvNYUZhsaAUlwk4_n94KNgK50rhfD-0",
            databaseURL: "https://al-qasr-hospital-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let categories = [];
        let allData = {};
        let currentEditingImg = "";

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙÙŠØ±Ø¨ÙŠØ²
        rdb.ref('categories').on('value', s => {
            const val = s.val();
            categories = val ? Object.entries(val).map(([id, name]) => ({id, name})) : [];
            renderCategories();
            updateAdminCats();
        });

        rdb.ref('bookings').on('value', s => {
            allData = s.val() || {};
            renderManageDataList();
        });

        rdb.ref('site_config').on('value', s => {
            const d = s.val() || {};
            document.getElementById('mainHeading').innerText = d.name || "Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙØ±Ù†Ø³ÙŠ";
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        function addCategory() {
            const name = document.getElementById('newCatInp').value;
            if(name) {
                rdb.ref('categories').push(name);
                document.getElementById('newCatInp').value = '';
            }
        }

        function deleteCategory(id) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙˆÙƒÙ„ Ù…Ø§ ÙŠØ­ØªÙˆÙŠÙ‡ØŸ")) {
                rdb.ref('categories/' + id).remove();
            }
        }

        function renderCategories() {
            const container = document.getElementById('mainCategories');
            container.innerHTML = '';
            categories.forEach(cat => {
                const b = document.createElement('button');
                b.className = 'cat-btn';
                let icon = "ğŸ¥"; 
                if(cat.name.includes("Ø¯ÙƒØªÙˆØ±") || cat.name.includes("Ø£Ø·Ø¨Ø§Ø¡")) icon = "ğŸ‘¨â€âš•ï¸";
                b.innerHTML = `<span>${icon}</span> ${cat.name}`;
                b.onclick = () => openCategory(cat.name);
                container.appendChild(b);
            });
        }

        function updateAdminCats() {
            const sel = document.getElementById('parentCatSelect');
            sel.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
            const list = document.getElementById('catsList');
            list.innerHTML = categories.map(c => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${c.name}</span> <button onclick="deleteCategory('${c.id}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`).join('');
        }

        function openCategory(catName) {
            document.getElementById('mainCategories').style.display = 'none';
            document.getElementById('subPage').style.display = 'block';
            document.getElementById('currentCatTitle').innerText = catName;
            const container = document.getElementById('buttonsContainer');
            container.innerHTML = '';
            for (let key in allData) {
                if (allData[key].parentCat === catName) {
                    const d = allData[key];
                    const b = document.createElement('button');
                    b.className = 'main-btn';
                    b.innerText = d.btnName;
                    b.onclick = () => showDetails(d);
                    container.appendChild(b);
                }
            }
        }

        function goBack() {
            document.getElementById('mainCategories').style.display = 'grid';
            document.getElementById('subPage').style.display = 'none';
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function saveToFirebase() {
            const key = document.getElementById('editKey').value;
            const file = document.getElementById('imgFile').files[0];
            let imgToSave = currentEditingImg;

            if (file) { 
                imgToSave = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); }); 
            }
            
            const fields = [];
            document.querySelectorAll('.dynamic-row').forEach(row => {
                fields.push({label: row.querySelector('.f-label').value, value: row.querySelector('.f-value').value});
            });

            const data = {
                parentCat: document.getElementById('parentCatSelect').value,
                btnName: document.getElementById('btnName').value,
                img: imgToSave,
                map: document.getElementById('mapLink').value,
                whatsapp: "20" + document.getElementById('whatsapp').value.replace(/^0/, '').replace(/\s/g, ''),
                time: `Ù…Ù† ${document.getElementById('tStart').value} ${document.getElementById('pStart').value} Ø¥Ù„Ù‰ ${document.getElementById('tEnd').value} ${document.getElementById('pEnd').value}`,
                fields: fields
            };

            if (key) await rdb.ref('bookings/' + key).set(data);
            else await rdb.ref('bookings').push(data);
            
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            resetForm();
        }

        function showDetails(d) {
            document.getElementById('modalTitle').innerText = d.btnName;
            const im = document.getElementById('modalImg');
            if(d.img) { im.src = d.img; im.style.display = 'block'; } else { im.style.display = 'none'; }
            let h = `<p>â° <b>Ø§Ù„Ù…ÙˆØ¹Ø¯:</b> ${d.time}</p>`;
            if(d.fields) d.fields.forEach(f => h += `<p><b>${f.label}:</b> ${f.value}</p>`);
            document.getElementById('modalDataBox').innerHTML = h;
            const mBtn = document.getElementById('modalMap');
            if(d.map) { mBtn.href = d.map; mBtn.style.display = 'block'; } else { mBtn.style.display = 'none'; }
            document.getElementById('modalWa').href = `https://wa.me/${d.whatsapp}`;
            document.getElementById('detailModal').style.display = 'flex';
        }

        function renderManageDataList() {
            const list = document.getElementById('manageDataList');
            list.innerHTML = '<h4>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>';
            for (let key in allData) {
                const d = allData[key];
                const m = document.createElement('div');
                m.style = "display:flex; justify-content:space-between; background:#fff; padding:10px; border-radius:10px; margin-bottom:5px; border:1px solid #eee; align-items:center; font-size:12px;";
                m.innerHTML = `<span>[${d.parentCat}] ${d.btnName}</span> 
                <div>
                    <button onclick="prepareEdit('${key}')" style="background:#eab308; color:white; border:none; padding:5px; border-radius:5px;">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="deleteItem('bookings/${key}')" style="background:#ef4444; color:white; border:none; padding:5px; border-radius:5px;">Ø­Ø°Ù</button>
                </div>`;
                list.appendChild(m);
            }
        }

        function prepareEdit(key) {
            const d = allData[key];
            document.getElementById('editKey').value = key;
            document.getElementById('parentCatSelect').value = d.parentCat;
            document.getElementById('btnName').value = d.btnName;
            document.getElementById('mapLink').value = d.map || '';
            currentEditingImg = d.img || "";
            document.getElementById('whatsapp').value = d.whatsapp.replace('20', '');
            document.getElementById('customFields').innerHTML = '';
            if(d.fields) d.fields.forEach(f => addCustomField(f.label, f.value));
            document.getElementById('formTitle').innerText = "ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('mainSaveBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('cancelEditBtn').style.display = "block";
            document.getElementById('adminPanel').scrollTo(0,0);
        }

        function addCustomField(l, v) {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.style = "display:flex; gap:5px; margin-bottom:5px;";
            div.innerHTML = `<input type="text" value="${l}" class="f-label" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="flex:1; margin:0;"><input type="text" value="${v}" class="f-value" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„" style="flex:2; margin:0;"><button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; font-weight:bold;">X</button>`;
            document.getElementById('customFields').appendChild(div);
        }

        function checkAdmin() { if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1987") document.getElementById('adminPanel').style.display = 'block'; }
        function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }
        function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
        function deleteItem(path) { if(confirm("Ø­Ø°ÙØŸ")) rdb.ref(path).remove(); }
        function resetForm() { 
            document.getElementById('editKey').value = ''; document.getElementById('customFields').innerHTML = ''; addCustomField('Ø§Ù„Ø¯ÙƒØªÙˆØ±', ''); addCustomField('Ø§Ù„Ø³Ø¹Ø±', '');
            document.getElementById('formTitle').innerText = "â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('mainSaveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…";
            document.getElementById('cancelEditBtn').style.display = "none";
            currentEditingImg = "";
        }
    </script>
</body>
</html>
