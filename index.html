<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙØ±Ù†Ø³ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #0284c7; --bg: #f8fafc; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #e0f2fe; margin: 0; padding: 15px; direction: rtl; }
        
        .header { text-align: center; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid white; }
        #pathDisplay { font-size: 13px; color: var(--primary); font-weight: bold; background: #fff; padding: 5px 15px; border-radius: 50px; display: inline-block; margin-top: 5px; border: 1px solid #bae6fd; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { 
            background: var(--white); padding: 25px 10px; border-radius: 20px; text-align: center; 
            cursor: pointer; box-shadow: 0 5px 0 #bae6fd; transition: 0.1s; border: 1px solid #e0f2fe;
            display: flex; flex-direction: column; align-items: center; gap: 10px; font-weight: bold; color: #0369a1;
        }
        .card:active { transform: translateY(3px); box-shadow: none; }
        .card.dr-card { background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border: 1px solid var(--primary); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 9999; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .admin-box { background: white; padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h4 { margin: 0 0 15px 0; color: var(--primary); border-right: 4px solid var(--primary); padding-right: 10px; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 12px; box-sizing: border-box; font-size: 14px; }
        .time-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .field-row { display: flex; gap: 5px; margin-bottom: 8px; background: #f1f5f9; padding: 8px; border-radius: 10px; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; transition: 0.2s; }
        .btn-main { background: var(--primary); }
        .btn-green { background: #10b981; }
        .btn-red { background: #ef4444; }
        .btn-edit { background: #f59e0b; padding: 6px 12px; width: auto; font-size: 12px; border-radius: 8px; }
        .btn-del { background: #ef4444; padding: 6px 12px; width: auto; font-size: 12px; border-radius: 8px; }

        /* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .content-manager { margin-top: 10px; border-top: 2px dashed #e2e8f0; padding-top: 15px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border: 1px solid #edf2f7; border-radius: 12px; margin-bottom: 8px; font-size: 14px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 10000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; }
        #modalImg { width: 100%; border-radius: 20px; max-height: 200px; object-fit: cover; margin-bottom: 15px; }

        .admin-trigger { position: fixed; bottom: 15px; left: 15px; width: 45px; height: 45px; opacity: 0.2; cursor: pointer; z-index: 10001; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; color:#0369a1;">Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙØ±Ù†Ø³ÙŠ</h2>
        <div id="pathDisplay">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    </div>

    <div id="mainGrid" class="grid"></div>

    <div id="navButtons" style="display:none; margin-top:20px;">
        <button class="btn" style="background:#64748b" onclick="goBack()">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø®Ø·ÙˆØ©</button>
        <button class="btn" style="background:#0369a1" onclick="goHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <div class="admin-trigger" onclick="openAdmin()">âš™ï¸</div>

    <div id="adminPanel">
        <h2 style="text-align:center; color: var(--primary);">Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ…</h2>
        
        <div class="admin-box">
            <h4>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h4>
            <input type="hidden" id="editCatId">
            <select id="catParent"><option value="root">-- ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --</option></select>
            <input type="text" id="catName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <button class="btn btn-main" id="catBtn" onclick="saveCategory()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… âœ…</button>
        </div>

        <div class="admin-box">
            <h4>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙƒØªÙˆØ±</h4>
            <input type="hidden" id="editDrId">
            <select id="drParent"></select>
            <input type="text" id="drName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±">
            <input type="file" id="drFile" accept="image/*">
            
            <p style="font-size:12px; margin:5px 0; font-weight: bold;">â° Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:</p>
            <div class="time-row">
                <input type="text" id="tFrom" placeholder="Ù…Ù†" style="flex:1">
                <select id="pFrom" style="flex:1"><option>ØµØ¨Ø§Ø­Ø§Ù‹</option><option>Ù…Ø³Ø§Ø¡Ù‹</option></select>
                <input type="text" id="tTo" placeholder="Ø¥Ù„Ù‰" style="flex:1">
                <select id="pTo" style="flex:1"><option>Ù…Ø³Ø§Ø¡Ù‹</option><option>ØµØ¨Ø§Ø­Ø§Ù‹</option></select>
            </div>

            <p style="font-size:12px; margin:5px 0; font-weight: bold;">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</p>
            <div id="dynamicFields"></div>
            <button class="btn" style="background:#6366f1; font-size:12px; padding:8px;" onclick="addField()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª</button>
            
            <input type="text" id="drWa" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø£ØµÙØ§Ø±)">
            <button class="btn btn-green" id="drBtn" onclick="saveDoctor()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± âœ…</button>
        </div>

        <div class="admin-box">
            <h4>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù)</h4>
            <p style="font-size: 11px; color: #64748b;">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ù…Ø§ Ø¨Ø¯Ø§Ø®Ù„Ù‡ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡:</p>
            <select id="filterSelect" onchange="syncAdminList()"></select>
            <div id="manageList" class="content-manager"></div>
        </div>

        <button class="btn btn-red" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>

    <div id="modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="mTitle" style="color:#0369a1; margin-top: 0;"></h2>
            <img id="modalImg">
            <div id="mInfo" style="text-align:right; background:#f0f9ff; padding:15px; border-radius:20px; font-size:14px; line-height: 1.6;"></div>
            <a id="mWa" class="btn btn-green" style="text-decoration:none; display:block; background: #128c7e;" target="_blank">ğŸ’¬ Ø­Ø¬Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
            <button class="btn" style="background:none; color:#64748b" onclick="document.getElementById('modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const config = {
            apiKey: "AIzaSyDpRvNYUZhsaAUlwk4_n94KNgK50rhfD-0",
            databaseURL: "https://al-qasr-hospital-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let dataStore = { cats: {}, drs: {} };
        let currentPath = ['root'];

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.ref('final_v3').on('value', (s) => {
            dataStore = s.val() || { cats: {}, drs: {} };
            render();
            syncAdminUI();
        });

        // --- Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        function render() {
            const grid = document.getElementById('mainGrid');
            const parent = currentPath[currentPath.length - 1];
            grid.innerHTML = '';
            
            document.getElementById('pathDisplay').innerText = currentPath.join(' > ').replace('root', 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
            document.getElementById('navButtons').style.display = currentPath.length > 1 ? 'block' : 'none';

            if(dataStore.cats) {
                Object.values(dataStore.cats).forEach(c => {
                    if(c.parent === parent) {
                        const d = document.createElement('div');
                        d.className = 'card';
                        d.innerHTML = `<span style="font-size:35px">ğŸ“‚</span> ${c.name}`;
                        d.onclick = () => { currentPath.push(c.name); render(); };
                        grid.appendChild(d);
                    }
                });
            }

            if(dataStore.drs) {
                Object.values(dataStore.drs).forEach(dr => {
                    if(dr.parent === parent) {
                        const d = document.createElement('div');
                        d.className = 'card dr-card';
                        d.innerHTML = `<span style="font-size:35px">ğŸ‘¨â€âš•ï¸</span> ${dr.name}`;
                        d.onclick = () => showDr(dr);
                        grid.appendChild(d);
                    }
                });
            }
        }

        function goBack() { currentPath.pop(); render(); }
        function goHome() { currentPath = ['root']; render(); }

        // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
        function addField(l='', v='') {
            const div = document.createElement('div');
            div.className = 'field-row';
            div.innerHTML = `<input type="text" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (Ø§Ù„ØªØ®ØµØµ)" value="${l}" class="f-l">
                             <input type="text" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„" value="${v}" class="f-v">
                             <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; font-weight:bold;">X</button>`;
            document.getElementById('dynamicFields').appendChild(div);
        }

        function saveCategory() {
            const name = document.getElementById('catName').value;
            const parent = document.getElementById('catParent').value;
            const id = document.getElementById('editCatId').value;
            if(!name) return;

            if(id) db.ref('final_v3/cats/'+id).update({ name, parent });
            else db.ref('final_v3/cats').push({ name, parent });
            
            document.getElementById('catName').value = '';
            document.getElementById('editCatId').value = '';
            document.getElementById('catBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… âœ…";
        }

        async function saveDoctor() {
            const name = document.getElementById('drName').value;
            const parent = document.getElementById('drParent').value;
            const id = document.getElementById('editDrId').value;
            const file = document.getElementById('drFile').files[0];
            let img = "";
            
            if(file) img = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });

            const fields = [];
            document.querySelectorAll('.field-row').forEach(row => {
                fields.push({ label: row.querySelector('.f-l').value, value: row.querySelector('.f-v').value });
            });

            const timeStr = `Ù…Ù† ${document.getElementById('tFrom').value} ${document.getElementById('pFrom').value} Ø¥Ù„Ù‰ ${document.getElementById('tTo').value} ${document.getElementById('pTo').value}`;
            const data = { name, parent, time: timeStr, fields, wa: document.getElementById('drWa').value };
            if(img) data.img = img;

            if(id) db.ref('final_v3/drs/'+id).update(data);
            else db.ref('final_v3/drs').push(data);
            
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
            resetDrForm();
        }

        function syncAdminUI() {
            const cp = document.getElementById('catParent');
            const dp = document.getElementById('drParent');
            const filter = document.getElementById('filterSelect');
            
            let opts = '<option value="root">-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --</option>';
            if(dataStore.cats) Object.values(dataStore.cats).forEach(c => opts += `<option value="${c.name}">${c.name}</option>`);
            
            cp.innerHTML = opts;
            dp.innerHTML = opts;
            filter.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆØ§Ù‡ --</option>' + opts;
            syncAdminList();
        }

        function syncAdminList() {
            const list = document.getElementById('manageList');
            const filter = document.getElementById('filterSelect').value;
            if(!filter) { list.innerHTML = '<p style="text-align:center; color:#94a3b8;">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆØ§Ù‡</p>'; return; }

            list.innerHTML = '';
            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù„ÙŠ Ø¬ÙˆÙ‡ Ø§Ù„Ù‚Ø³Ù… Ø¯Ù‡
            if(dataStore.cats) Object.entries(dataStore.cats).forEach(([id, c]) => {
                if(c.parent === filter) {
                    list.innerHTML += `<div class="item-row"><span>ğŸ“‚ Ø§Ù„Ù‚Ø³Ù…: ${c.name}</span> 
                        <div><button class="btn-edit" onclick="editCat('${id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-del" onclick="del('cats','${id}')">Ø­Ø°Ù</button></div></div>`;
                }
            });
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ø§Ù„Ù„ÙŠ Ø¬ÙˆÙ‡ Ø§Ù„Ù‚Ø³Ù… Ø¯Ù‡
            if(dataStore.drs) Object.entries(dataStore.drs).forEach(([id, d]) => {
                if(d.parent === filter) {
                    list.innerHTML += `<div class="item-row"><span>ğŸ‘¨â€âš•ï¸ Ø¯. ${d.name}</span> 
                        <div><button class="btn-edit" onclick="editDr('${id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-del" onclick="del('drs','${id}')">Ø­Ø°Ù</button></div></div>`;
                }
            });
        }

        function editCat(id) {
            const c = dataStore.cats[id];
            document.getElementById('editCatId').value = id;
            document.getElementById('catName').value = c.name;
            document.getElementById('catParent').value = c.parent;
            document.getElementById('catBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… ğŸ”„";
            window.scrollTo(0,0);
        }

        function editDr(id) {
            const d = dataStore.drs[id];
            document.getElementById('editDrId').value = id;
            document.getElementById('drName').value = d.name;
            document.getElementById('drParent').value = d.parent;
            document.getElementById('drWa').value = d.wa;
            document.getElementById('dynamicFields').innerHTML = '';
            if(d.fields) d.fields.forEach(f => addField(f.label, f.value));
            document.getElementById('drBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± ğŸ”„";
            window.scrollTo(0,0);
        }

        function del(t, id) { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) db.ref(`final_v3/${t}/${id}`).remove(); }

        function showDr(dr) {
            document.getElementById('mTitle').innerText = dr.name;
            const img = document.getElementById('modalImg');
            if(dr.img) { img.src = dr.img; img.style.display = 'block'; } else { img.style.display = 'none'; }
            let info = `<p><b>ğŸ•’ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:</b> ${dr.time}</p>`;
            if(dr.fields) dr.fields.forEach(f => info += `<p><b>${f.label}:</b> ${f.value}</p>`);
            document.getElementById('mInfo').innerHTML = info;
            document.getElementById('mWa').href = `https://wa.me/20${dr.wa}`;
            document.getElementById('modal').style.display = 'flex';
        }

        function resetDrForm() {
            document.getElementById('drName').value=''; document.getElementById('editDrId').value='';
            document.getElementById('drFile').value=''; document.getElementById('drWa').value='';
            document.getElementById('dynamicFields').innerHTML='';
            document.getElementById('drBtn').innerText = "Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙƒØªÙˆØ± âœ…";
        }

        function openAdmin() { if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1987") document.getElementById('adminPanel').style.display='block'; }
        function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }
    </script>
</body>
</html>
